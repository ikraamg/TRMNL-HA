<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Puppet - Schedule Manager</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --ha-blue: #03a9f4;
        --ha-blue-dark: #0288d1;
        --ha-blue-light: #4fc3f7;
      }
      body {
        background: linear-gradient(135deg, #03a9f4 0%, #0288d1 100%);
        min-height: 100vh;
      }
      .preview-img {
        max-width: 100%;
        height: auto;
        border: 2px solid var(--ha-blue);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .tab-active {
        background-color: white;
        color: var(--ha-blue-dark);
        border-bottom: 2px solid white;
      }
      .tab-inactive {
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
      }
      .tab-inactive:hover {
        background-color: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>

  <body class="p-4">
    <div class="container mx-auto max-w-7xl">
      <!-- Tab Bar -->
      <div class="flex items-end gap-1 mb-0">
        <div id="tabBar" class="flex gap-1 flex-wrap">
          <!-- Tabs will be rendered here -->
        </div>

        <button
          onclick="createNewSchedule()"
          class="px-4 py-2 rounded-t-lg font-semibold transition-all"
          style="background-color: rgba(255, 255, 255, 0.3); color: white"
          onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.5)'"
          onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.3)'"
        >
          + New
        </button>
      </div>

      <!-- Tab Content -->
      <div
        id="tabContent"
        class="bg-white rounded-b-lg rounded-tr-lg shadow-lg p-6"
      >
        <p class="text-gray-500 text-center py-8">Loading schedules...</p>
      </div>

      <!-- Footer -->
      <div class="mt-6 text-center">
        <a
          href="https://github.com/balloob/home-assistant-addons/blob/main/puppet/README.md"
          target="_blank"
          rel="noopener noreferrer"
          class="
            text-white font-bold hover:underline opacity-80
            hover:opacity-100 transition-opacity
          "
        >
          Puppet by Balloob
        </a>
      </div>
    </div>

    <script>
      // Global state
      let schedules = [];
      let activeScheduleId = null;
      let autoRefresh = localStorage.getItem('puppetAutoRefresh') === 'true';

      // Load all schedules from API
      async function loadSchedules() {
        try {
          const response = await fetch("./api/schedules");
          schedules = await response.json();
          renderTabs();
          if (schedules.length > 0 && !activeScheduleId) {
            selectSchedule(schedules[0].id);
          } else if (schedules.length === 0) {
            renderEmptyState();
          } else {
            selectSchedule(activeScheduleId);
          }
        } catch (err) {
          console.error("Error loading schedules:", err);
          document.getElementById("tabContent").innerHTML =
            '<p class="text-red-500 text-center py-8">Error loading schedules</p>';
        }
      }

      // Render tab bar
      function renderTabs() {
        const tabBar = document.getElementById("tabBar");
        tabBar.innerHTML = schedules
          .map(
            (schedule) => `
          <button
            onclick="selectSchedule('${schedule.id}')"
            class="px-4 py-2 rounded-t-lg font-semibold transition-all ${
              schedule.id === activeScheduleId ? "tab-active" : "tab-inactive"
            }"
          >
            ${schedule.enabled ? '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>' : ''}${schedule.name || "Untitled"}
          </button>
        `
          )
          .join("");
      }

      // Select a schedule tab
      function selectSchedule(id) {
        activeScheduleId = id;
        renderTabs();
        const schedule = schedules.find((s) => s.id === id);
        if (schedule) {
          renderScheduleContent(schedule);
        }
      }

      // Render empty state
      function renderEmptyState() {
        document.getElementById("tabContent").innerHTML = `
          <div class="text-center py-12">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <h3 class="text-lg font-semibold text-gray-600 mb-2">No Schedules</h3>
            <p class="text-gray-500 mb-4">Create your first schedule to get started</p>
            <button
              onclick="createNewSchedule()"
              class="px-6 py-2 text-white rounded-md transition duration-200"
              style="background-color: var(--ha-blue)"
            >
              + New Schedule
            </button>
          </div>
        `;
      }

      // Create new schedule
      async function createNewSchedule() {
        const newSchedule = {
          name: "New Schedule",
          cron: "*/10 * * * *",
          dashboard_path: "/lovelace/0",
          viewport: { width: 758, height: 1024 },
          webhook_url: "",
          format: "png",
          dithering: {
            enabled: true,
            method: "floyd-steinberg",
            bitDepth: 2,
            gammaCorrection: true,
            blackLevel: 0,
            whiteLevel: 100,
          },
        };

        try {
          const response = await fetch("./api/schedules", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newSchedule),
          });
          const created = await response.json();
          schedules.push(created);
          selectSchedule(created.id);
          renderTabs();
        } catch (err) {
          console.error("Error creating schedule:", err);
          alert("Error creating schedule");
        }
      }

      // Delete schedule
      async function deleteSchedule(id) {
        if (!confirm("Are you sure you want to delete this schedule?")) return;

        try {
          await fetch(`./api/schedules/${id}`, { method: "DELETE" });
          schedules = schedules.filter((s) => s.id !== id);
          if (activeScheduleId === id) {
            activeScheduleId = schedules.length > 0 ? schedules[0].id : null;
          }
          renderTabs();
          if (schedules.length > 0) {
            selectSchedule(activeScheduleId);
          } else {
            renderEmptyState();
          }
        } catch (err) {
          console.error("Error deleting schedule:", err);
          alert("Error deleting schedule");
        }
      }

      // Render schedule content
      function renderScheduleContent(schedule) {
        const content = document.getElementById("tabContent");
        content.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Settings Column -->
            <div class="lg:col-span-1 space-y-4">
              <!-- Schedule Info -->
              <div class="border-b pb-4">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--ha-blue-dark)">Schedule</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between p-3 rounded-md ${schedule.enabled ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                    <div class="flex items-center">
                      <input type="checkbox" id="s_enabled" ${schedule.enabled ? "checked" : ""}
                        class="h-5 w-5 border-gray-300 rounded"
                        onchange="updateField('enabled', this.checked)" />
                      <label for="s_enabled" class="ml-2 font-medium ${schedule.enabled ? 'text-green-700' : 'text-gray-600'}">
                        ${schedule.enabled ? 'Enabled' : 'Disabled'}
                      </label>
                    </div>
                    ${schedule.enabled ? '<span class="text-xs text-green-600">Running on schedule</span>' : ''}
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="s_name" value="${schedule.name || ""}"
                      class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateField('name', this.value)" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cron Expression</label>
                    <input type="text" id="s_cron" value="${schedule.cron || ""}"
                      class="w-full px-3 py-2 border rounded-md font-mono" style="border-color: var(--ha-blue-light)"
                      onchange="updateField('cron', this.value)" />
                    <p class="text-xs text-gray-500 mt-1">
                      <a href="https://crontab.guru" target="_blank" class="underline" style="color: var(--ha-blue)">Cron helper</a>
                    </p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                    <input type="url" id="s_webhook" value="${schedule.webhook_url || ""}"
                      class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateField('webhook_url', this.value)"
                      placeholder="https://your-server.com/upload" />
                  </div>
                </div>
              </div>

              <!-- Screenshot Settings -->
              <div class="border-b pb-4">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--ha-blue-dark)">Screenshot</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dashboard Path</label>
                    <input type="text" id="s_path" value="${schedule.dashboard_path || "/lovelace/0"}"
                      class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateField('dashboard_path', this.value)" />
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Width</label>
                      <input type="number" id="s_width" value="${schedule.viewport?.width || 758}"
                        class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                        onchange="updateViewport()" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Height</label>
                      <input type="number" id="s_height" value="${schedule.viewport?.height || 1024}"
                        class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                        onchange="updateViewport()" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Format</label>
                    <select id="s_format" class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateField('format', this.value)">
                      <option value="png" ${schedule.format === "png" ? "selected" : ""}>PNG</option>
                      <option value="jpeg" ${schedule.format === "jpeg" ? "selected" : ""}>JPEG</option>
                      <option value="webp" ${schedule.format === "webp" ? "selected" : ""}>WebP</option>
                      <option value="bmp" ${schedule.format === "bmp" ? "selected" : ""}>BMP</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Dithering Settings -->
              <div>
                <h3 class="text-lg font-semibold mb-3" style="color: var(--ha-blue-dark)">Dithering</h3>
                <div class="space-y-3">
                  <div class="flex items-center">
                    <input type="checkbox" id="s_dithering" ${schedule.dithering?.enabled ? "checked" : ""}
                      class="h-4 w-4 border-gray-300 rounded"
                      onchange="updateDithering('enabled', this.checked)" />
                    <label for="s_dithering" class="ml-2 text-sm text-gray-700">Enable Advanced Dithering</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Method</label>
                    <select id="s_method" class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateDithering('method', this.value)">
                      <option value="floyd-steinberg" ${schedule.dithering?.method === "floyd-steinberg" ? "selected" : ""}>Floyd-Steinberg</option>
                      <option value="ordered" ${schedule.dithering?.method === "ordered" ? "selected" : ""}>Ordered</option>
                      <option value="none" ${schedule.dithering?.method === "none" ? "selected" : ""}>None</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bit Depth</label>
                    <select id="s_bitdepth" class="w-full px-3 py-2 border rounded-md" style="border-color: var(--ha-blue-light)"
                      onchange="updateDithering('bitDepth', parseInt(this.value))">
                      <option value="1" ${schedule.dithering?.bitDepth === 1 ? "selected" : ""}>1-bit (B&W)</option>
                      <option value="2" ${schedule.dithering?.bitDepth === 2 ? "selected" : ""}>2-bit (4 grays)</option>
                      <option value="4" ${schedule.dithering?.bitDepth === 4 ? "selected" : ""}>4-bit (16 grays)</option>
                      <option value="8" ${schedule.dithering?.bitDepth === 8 ? "selected" : ""}>8-bit (256 grays)</option>
                    </select>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="s_gamma" ${schedule.dithering?.gammaCorrection !== false ? "checked" : ""}
                      class="h-4 w-4 border-gray-300 rounded"
                      onchange="updateDithering('gammaCorrection', this.checked)" />
                    <label for="s_gamma" class="ml-2 text-sm text-gray-700">Gamma Correction</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Black Level: <span id="black_val">${schedule.dithering?.blackLevel || 0}</span>%</label>
                    <input type="range" id="s_black" min="0" max="50" value="${schedule.dithering?.blackLevel || 0}"
                      class="w-full"
                      oninput="document.getElementById('black_val').textContent=this.value"
                      onchange="updateDithering('blackLevel', parseInt(this.value))" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">White Level: <span id="white_val">${schedule.dithering?.whiteLevel || 100}</span>%</label>
                    <input type="range" id="s_white" min="50" max="100" value="${schedule.dithering?.whiteLevel || 100}"
                      class="w-full"
                      oninput="document.getElementById('white_val').textContent=this.value"
                      onchange="updateDithering('whiteLevel', parseInt(this.value))" />
                  </div>
                </div>
              </div>

              <!-- Delete Button -->
              <div class="pt-4 border-t">
                <button onclick="deleteSchedule('${schedule.id}')"
                  class="w-full px-4 py-2 text-red-700 bg-red-100 rounded-md hover:bg-red-200 transition">
                  Delete Schedule
                </button>
              </div>
            </div>

            <!-- Preview Column -->
            <div class="lg:col-span-2">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--ha-blue-dark)">Preview</h3>
                <div class="flex items-center gap-4">
                  <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                    <input type="checkbox" id="autoRefreshToggle" ${autoRefresh ? 'checked' : ''}
                      class="h-4 w-4 border-gray-300 rounded"
                      onchange="toggleAutoRefresh(this.checked)" />
                    Auto-refresh
                  </label>
                  <span id="loadTime" class="text-sm text-gray-500"></span>
                  <button onclick="loadPreview()"
                    class="px-4 py-2 text-white rounded-md transition"
                    style="background-color: var(--ha-blue)">
                    Refresh
                  </button>
                </div>
              </div>

              <div id="previewContainer" class="bg-gray-50 rounded-lg p-4 min-h-[400px] flex items-center justify-center">
                <div id="previewPlaceholder" class="text-center text-gray-400">
                  <svg class="mx-auto h-16 w-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <p>Click Refresh to generate preview</p>
                </div>
                <div id="loadingIndicator" class="hidden text-center">
                  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-t-transparent"
                    style="border-color: var(--ha-blue); border-top-color: transparent"></div>
                  <p class="mt-4 text-gray-600">Generating screenshot...</p>
                </div>
                <img id="previewImage" src="" alt="Preview" class="preview-img hidden" />
              </div>

              <div id="errorMessage" class="hidden mt-4 bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-md">
                <p id="errorText"></p>
              </div>
            </div>
          </div>
        `;
      }

      // Toggle auto-refresh
      function toggleAutoRefresh(enabled) {
        autoRefresh = enabled;
        localStorage.setItem('puppetAutoRefresh', enabled);
        if (enabled) {
          loadPreview();
        }
      }

      // Update a field and save
      async function updateField(field, value) {
        const schedule = schedules.find((s) => s.id === activeScheduleId);
        if (!schedule) return;

        schedule[field] = value;
        await saveSchedule(schedule);

        // Re-render UI for visual changes
        if (field === "name" || field === "enabled") {
          renderTabs();
          if (field === "enabled") {
            renderScheduleContent(schedule);
          }
        }

        // Auto-refresh preview for screenshot-related fields
        if (autoRefresh && ["dashboard_path", "format"].includes(field)) {
          loadPreview();
        }
      }

      // Update viewport
      async function updateViewport() {
        const schedule = schedules.find((s) => s.id === activeScheduleId);
        if (!schedule) return;

        schedule.viewport = {
          width: parseInt(document.getElementById("s_width").value),
          height: parseInt(document.getElementById("s_height").value),
        };
        await saveSchedule(schedule);

        if (autoRefresh) {
          loadPreview();
        }
      }

      // Update dithering option
      async function updateDithering(field, value) {
        const schedule = schedules.find((s) => s.id === activeScheduleId);
        if (!schedule) return;

        if (!schedule.dithering) {
          schedule.dithering = {};
        }
        schedule.dithering[field] = value;
        await saveSchedule(schedule);

        if (autoRefresh) {
          loadPreview();
        }
      }

      // Save schedule to API
      async function saveSchedule(schedule) {
        try {
          await fetch(`./api/schedules/${schedule.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(schedule),
          });
        } catch (err) {
          console.error("Error saving schedule:", err);
        }
      }

      // Load preview for current schedule
      async function loadPreview() {
        const schedule = schedules.find((s) => s.id === activeScheduleId);
        if (!schedule) return;

        const placeholder = document.getElementById("previewPlaceholder");
        const loading = document.getElementById("loadingIndicator");
        const image = document.getElementById("previewImage");
        const error = document.getElementById("errorMessage");
        const loadTime = document.getElementById("loadTime");

        placeholder.classList.add("hidden");
        image.classList.add("hidden");
        error.classList.add("hidden");
        loading.classList.remove("hidden");
        loadTime.textContent = "";

        const startTime = performance.now();

        try {
          // Build URL
          const params = new URLSearchParams();
          params.append("viewport", `${schedule.viewport.width}x${schedule.viewport.height}`);
          if (schedule.format && schedule.format !== "png") {
            params.append("format", schedule.format);
          }
          if (schedule.dithering?.enabled) {
            params.append("dithering", "");
            params.append("dither_method", schedule.dithering.method || "floyd-steinberg");
            params.append("bit_depth", schedule.dithering.bitDepth || 2);
            if (!schedule.dithering.gammaCorrection) {
              params.append("no_gamma", "");
            }
            if (schedule.dithering.blackLevel > 0) {
              params.append("black_level", schedule.dithering.blackLevel);
            }
            if (schedule.dithering.whiteLevel < 100) {
              params.append("white_level", schedule.dithering.whiteLevel);
            }
          }

          const url = `.${schedule.dashboard_path}?${params.toString()}`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);

          const endTime = performance.now();
          loadTime.textContent = `${Math.round(endTime - startTime)}ms`;

          image.src = imageUrl;
          image.classList.remove("hidden");
        } catch (err) {
          console.error("Error loading preview:", err);
          document.getElementById("errorText").textContent = err.message;
          error.classList.remove("hidden");
          placeholder.classList.remove("hidden");
        } finally {
          loading.classList.add("hidden");
        }
      }

      // Initialize
      window.addEventListener("load", loadSchedules);
    </script>
  </body>
</html>
